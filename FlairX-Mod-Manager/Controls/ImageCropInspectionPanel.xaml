<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="FlairX_Mod_Manager.Controls.ImageCropInspectionPanel"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Margin="24" x:Name="MainGrid" Background="Transparent" VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header with title -->
        <StackPanel Orientation="Horizontal" VerticalAlignment="Top" Margin="0,0,0,16">
            <TextBlock x:Name="TitleText" 
                      Text="Adjust Crop Area" 
                      FontSize="24" 
                      FontWeight="Bold" 
                      Margin="0,0,16,0" 
                      VerticalAlignment="Center"/>
            <TextBlock x:Name="SubtitleText" 
                      Text="Drag to reposition, use handles to resize" 
                      FontSize="14"
                      Opacity="0.7" 
                      VerticalAlignment="Center"
                      Margin="0,2,0,0"/>
            <!-- Batch mode counter -->
            <TextBlock x:Name="BatchCounterText" 
                      FontSize="14"
                      Opacity="0.7" 
                      VerticalAlignment="Center"
                      Margin="16,2,0,0"
                      Visibility="Collapsed"/>
        </StackPanel>

        <!-- Main content area with crop editor and batch list -->
        <Grid Grid.Row="1" VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition x:Name="BatchListColumn" Width="0"/>
            </Grid.ColumnDefinitions>
            
            <!-- Image Canvas with crop overlay -->
            <Grid Grid.Column="0" VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
            <Grid x:Name="ImageContentRoot" Margin="25">
                <Border x:Name="ImageBorder" 
                       CornerRadius="12" 
                       BorderThickness="15" 
                       BorderBrush="{ThemeResource TileBorderBrush}">
                    <Border CornerRadius="8" Background="{ThemeResource LayerFillColorDefaultBrush}">
                        <Grid x:Name="ImageContainer"
                             PointerPressed="Canvas_PointerPressed"
                             PointerMoved="Canvas_PointerMoved"
                             PointerReleased="Canvas_PointerReleased"
                             Background="Transparent">
                            
                            <!-- Source Image with dimmed overlay -->
                            <Viewbox x:Name="ImageViewbox" 
                                    Stretch="Uniform"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                                <Canvas x:Name="ImageCanvas">
                                    <!-- Source Image -->
                                    <Image x:Name="SourceImage" Stretch="None"/>
                                    
                                    <!-- Dimmed overlay outside crop area -->
                                    <Rectangle x:Name="DimTop" Fill="#80000000"/>
                                    <Rectangle x:Name="DimLeft" Fill="#80000000"/>
                                    <Rectangle x:Name="DimRight" Fill="#80000000"/>
                                    <Rectangle x:Name="DimBottom" Fill="#80000000"/>
                                </Canvas>
                            </Viewbox>
                            
                            <!-- Crop overlay - NOT scaled -->
                            <Canvas x:Name="CropOverlayCanvas" 
                                   Background="Transparent"
                                   IsHitTestVisible="True">
                                
                                <!-- Crop rectangle border -->
                                <Rectangle x:Name="CropRectangle" 
                                          Stroke="{ThemeResource AccentFillColorDefaultBrush}"
                                          StrokeThickness="3"
                                          Fill="Transparent"
                                          PointerPressed="CropBody_PointerPressed"/>
                                
                                <!-- Corner handles -->
                                <Ellipse x:Name="HandleTopLeft" Width="20" Height="20" 
                                        Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                        Stroke="White" StrokeThickness="2"
                                        PointerPressed="Handle_PointerPressed"
                                        Tag="TopLeft"/>
                                <Ellipse x:Name="HandleTopRight" Width="20" Height="20" 
                                        Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                        Stroke="White" StrokeThickness="2"
                                        PointerPressed="Handle_PointerPressed"
                                        Tag="TopRight"/>
                                <Ellipse x:Name="HandleBottomLeft" Width="20" Height="20" 
                                        Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                        Stroke="White" StrokeThickness="2"
                                        PointerPressed="Handle_PointerPressed"
                                        Tag="BottomLeft"/>
                                <Ellipse x:Name="HandleBottomRight" Width="20" Height="20" 
                                        Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                        Stroke="White" StrokeThickness="2"
                                        PointerPressed="Handle_PointerPressed"
                                        Tag="BottomRight"/>
                                
                                <!-- Edge handles -->
                                <Rectangle x:Name="HandleTop" Width="50" Height="10" 
                                          Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                          Stroke="White" StrokeThickness="2"
                                          RadiusX="5" RadiusY="5"
                                          PointerPressed="Handle_PointerPressed"
                                          Tag="Top"/>
                                <Rectangle x:Name="HandleBottom" Width="50" Height="10" 
                                          Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                          Stroke="White" StrokeThickness="2"
                                          RadiusX="5" RadiusY="5"
                                          PointerPressed="Handle_PointerPressed"
                                          Tag="Bottom"/>
                                <Rectangle x:Name="HandleLeft" Width="10" Height="50" 
                                          Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                          Stroke="White" StrokeThickness="2"
                                          RadiusX="5" RadiusY="5"
                                          PointerPressed="Handle_PointerPressed"
                                          Tag="Left"/>
                                <Rectangle x:Name="HandleRight" Width="10" Height="50" 
                                          Fill="{ThemeResource AccentFillColorDefaultBrush}" 
                                          Stroke="White" StrokeThickness="2"
                                          RadiusX="5" RadiusY="5"
                                          PointerPressed="Handle_PointerPressed"
                                          Tag="Right"/>
                            </Canvas>
                        </Grid>
                    </Border>
                </Border>
            </Grid>
            </Grid>
            
            <!-- Batch preview list (right side) -->
            <Border x:Name="BatchListPanel" 
                    Grid.Column="1" 
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1,0,0,0"
                    Visibility="Collapsed"
                    Margin="16,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Batch list header -->
                    <TextBlock x:Name="BatchListHeader" 
                              Text="Files to Process" 
                              FontSize="14" 
                              FontWeight="SemiBold"
                              Margin="12,12,12,8"/>
                    
                    <!-- Scrollable list of thumbnails -->
                    <ScrollViewer Grid.Row="1" 
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled"
                                  Padding="8,0,8,8">
                        <ItemsRepeater x:Name="BatchItemsRepeater">
                            <ItemsRepeater.Layout>
                                <StackLayout Orientation="Vertical" Spacing="8"/>
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate>
                                    <Border x:Name="ItemBorder"
                                            Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="8"
                                            PointerPressed="BatchItem_PointerPressed"
                                            PointerEntered="BatchItem_PointerEntered"
                                            PointerExited="BatchItem_PointerExited">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Thumbnail -->
                                            <Border Grid.Column="0" 
                                                    CornerRadius="4" 
                                                    Width="56" Height="56"
                                                    Background="{ThemeResource LayerFillColorDefaultBrush}">
                                                <Image Source="{Binding Thumbnail}" 
                                                       Stretch="UniformToFill"/>
                                            </Border>
                                            
                                            <!-- File info -->
                                            <StackPanel Grid.Column="1" 
                                                        VerticalAlignment="Center" 
                                                        Margin="8,0,0,0">
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           FontSize="12" 
                                                           FontWeight="SemiBold"
                                                           TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding StatusText}" 
                                                           FontSize="11" 
                                                           Opacity="0.7"
                                                           Margin="0,2,0,0"/>
                                            </StackPanel>
                                            
                                            <!-- Status icon -->
                                            <FontIcon Grid.Column="2" 
                                                      Glyph="{Binding StatusIcon}"
                                                      FontSize="16"
                                                      Foreground="{Binding StatusColor}"
                                                      VerticalAlignment="Center"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- Footer with info and buttons -->
        <Grid Grid.Row="2" Margin="0,16,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                <TextBlock x:Name="CropInfoText" 
                          Text="Crop: 600 × 722"
                          FontWeight="Bold"
                          FontSize="16"/>
                <TextBlock x:Name="ImageInfoText" 
                          Text="Image: 1920 × 1080" 
                          Opacity="0.7" 
                          FontSize="14"
                          Margin="0,4,0,0"/>
                <TextBlock x:Name="HintText" 
                          Text="Drag to move • Corners maintain ratio • Edges change ratio" 
                          Opacity="0.6" 
                          FontSize="12" 
                          Margin="0,4,0,0"/>
            </StackPanel>
            
            <StackPanel Grid.Column="1" 
                       Orientation="Horizontal" 
                       Spacing="8"
                       VerticalAlignment="Center">
                <Button x:Name="ResetButton" 
                       Click="ResetButton_Click"
                       MinWidth="100"
                       Height="40">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                        <TextBlock x:Name="ResetButtonText" Text="Reset"/>
                    </StackPanel>
                </Button>
                <Button x:Name="DeleteButton" 
                       Click="DeleteButton_Click"
                       MinWidth="100"
                       Height="40">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE74D;" FontSize="14"/>
                        <TextBlock x:Name="DeleteButtonText" Text="Delete"/>
                    </StackPanel>
                </Button>
                <Button x:Name="SkipButton" 
                       Click="SkipButton_Click"
                       MinWidth="100"
                       Height="40">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE8BB;" FontSize="14"/>
                        <TextBlock x:Name="SkipButtonText" Text="Skip"/>
                    </StackPanel>
                </Button>
                <!-- Single mode: Confirm button -->
                <Button x:Name="ConfirmButton" 
                       Content="Confirm" 
                       Style="{StaticResource AccentButtonStyle}"
                       Click="ConfirmButton_Click"
                       MinWidth="100"
                       Height="40"/>
                <!-- Batch mode: Next/Finalize buttons -->
                <Button x:Name="NextButton" 
                       Click="NextButton_Click"
                       MinWidth="100"
                       Height="40"
                       Visibility="Collapsed">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock x:Name="NextButtonText" Text="Next"/>
                        <FontIcon Glyph="&#xE72A;" FontSize="14"/>
                    </StackPanel>
                </Button>
                <Button x:Name="FinalizeButton" 
                       Style="{StaticResource AccentButtonStyle}"
                       Click="FinalizeButton_Click"
                       MinWidth="120"
                       Height="40"
                       Visibility="Collapsed">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE73E;" FontSize="14"/>
                        <TextBlock x:Name="FinalizeButtonText" Text="Finalize All"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
